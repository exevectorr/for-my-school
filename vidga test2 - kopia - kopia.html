<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>Vidga 3D Editor</title>
<style>
  body { margin:0; overflow:hidden; background:#000; font-family:sans-serif; }
  canvas { display:block; }

  /* Sidebar */
  #sidebar {
    position:fixed; left:0; top:0; bottom:0;
    width:250px; background:#111; border-right:2px solid #0f0;
    color:white; padding:10px; box-sizing:border-box; overflow-y:auto;
  }
  #sidebar h2 {
    font-size:16px; color:#0f0; border-bottom:1px solid #0f0;
    padding-bottom:5px; margin-bottom:10px;
  }
  #fileList button {
    display:block; width:100%; background:#222; color:#0f0;
    border:none; margin-bottom:5px; cursor:pointer; text-align:left; padding:5px;
  }
  #uiButtons button {
    width:100%; margin-bottom:5px; background:#0f0; color:#000;
    border:none; font-weight:bold; cursor:pointer; padding:5px;
  }

  /* Kod Editor */
  #editor {
    position:fixed; right:0; top:0; bottom:0; width:300px;
    background:#111; border-left:2px solid #0f0;
    color:white; padding:10px; display:flex; flex-direction:column;
    box-sizing:border-box;
  }
  #editor textarea {
    flex:1; background:#000; color:#0f0; border:1px solid #0f0;
    font-family:monospace; font-size:14px; padding:5px;
  }
  #editor button {
    margin-top:5px; background:#0f0; border:none;
    color:#000; font-weight:bold; padding:5px; cursor:pointer;
  }

  /* Settings */
  #settingsPanel {
    display:none;
    position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
    width:300px; background:#111; border:2px solid #0f0; color:white;
    padding:20px; z-index:10; text-align:center;
  }
  #settingsPanel label { display:block; margin-top:10px; }

  #testButton {
    display:none;
    position:fixed; top:10px; left:50%;
    transform:translateX(-50%);
    background:#0f0; color:#000; font-weight:bold;
    border:none; padding:10px 20px; cursor:pointer;
    z-index:10;
  }
</style>
</head>
<body>
<div id="sidebar">
  <h2>Filer</h2>
  <div id="fileList"></div>
  <div id="uiButtons">
    <button id="newFile">Ny Fil</button>
    <button id="addBlock">Lägg till Block</button>
    <button id="openSettings">⚙ Settings</button>
  </div>
</div>

<div id="editor">
  <h2>Kod Editor</h2>
  <textarea id="codeArea">// Skriv din Vidga-kod här...</textarea>
  <button id="runCode">Kör Kod</button>
</div>

<div id="settingsPanel">
  <h2>Inställningar</h2>
  <label><input type="checkbox" id="playableToggle"> Playable Mode</label>
  <button onclick="closeSettings()">Stäng</button>
</div>

<button id="testButton">Test</button>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script>
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000000);
const camera = new THREE.PerspectiveCamera(75, (window.innerWidth-550)/window.innerHeight, 0.1, 1000);
camera.position.set(0, 2, 5);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth-550, window.innerHeight);
renderer.domElement.style.position = "fixed";
renderer.domElement.style.left = "250px";
document.body.appendChild(renderer.domElement);

// --- Grid ---
let gridSize = 50;
let grid = new THREE.GridHelper(gridSize, gridSize, 0x00ff00, 0x004400);
scene.add(grid);

// --- Ljus ---
scene.add(new THREE.AmbientLight(0xffffff, 0.6));

// --- Blocksystem ---
const blocks = {};
let blockCounter = 0;
let selectedBlock = null;
let isDragging = false;
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

// --- Filhantering ---
let files = {};
let currentFile = null;
const fileList = document.getElementById("fileList");
const codeArea = document.getElementById("codeArea");

// --- Lägg till block ---
function addBlock(){
  blockCounter++;
  const id = `Block_${blockCounter}.VBC`;
  const mesh = new THREE.Mesh(
    new THREE.BoxGeometry(1,1,1),
    new THREE.MeshStandardMaterial({color:0x00ff88})
  );
  mesh.position.set(Math.random()*4-2, 0.5, Math.random()*4-2);
  scene.add(mesh);
  blocks[id] = { mesh: mesh, collision: false, size:[1,1,1] };

  const baseCode = 
`humanoidID(${id});
Collision(false);
size=10,10,10;
Coordinate(0,0,0);`;

  files[id] = baseCode;
  addFileButton(id);
}

function addFileButton(name){
  const btn = document.createElement("button");
  btn.textContent = name;
  btn.onclick = ()=>{
    currentFile = name;
    codeArea.value = files[name];
  };
  fileList.appendChild(btn);
}

// --- Drag ---
document.addEventListener("mousedown", (e)=>{
  if(e.clientX < 250 || e.clientX > window.innerWidth-300) return;
  mouse.x = ((e.clientX-250)/(window.innerWidth-550))*2 - 1;
  mouse.y = -(e.clientY/window.innerHeight)*2 + 1;
  raycaster.setFromCamera(mouse,camera);
  const intersects = raycaster.intersectObjects(Object.values(blocks).map(b=>b.mesh));
  if(intersects.length>0){
    selectedBlock = intersects[0].object;
    isDragging = true;
  }
});
document.addEventListener("mouseup", ()=>isDragging=false);
document.addEventListener("mousemove",(e)=>{
  if(isDragging && selectedBlock){
    mouse.x = ((e.clientX-250)/(window.innerWidth-550))*2 - 1;
    mouse.y = -(e.clientY/window.innerHeight)*2 + 1;
    raycaster.setFromCamera(mouse,camera);
    const plane = new THREE.Plane(new THREE.Vector3(0,1,0),0);
    const point = new THREE.Vector3();
    raycaster.ray.intersectPlane(plane, point);
    selectedBlock.position.copy(point);
    selectedBlock.position.y = 0.5;
  }
});

// --- Kamera ---
let move = {w:false,s:false,a:false,d:false};
let yaw=0,pitch=0, fallSpeed=0;
document.addEventListener("keydown", e=>{ if(e.key in move) move[e.key]=true; });
document.addEventListener("keyup", e=>{ if(e.key in move) move[e.key]=false; });

let isRightDown=false, prevX=0, prevY=0;
document.addEventListener("mousedown", e=>{ if(e.button===2){ isRightDown=true; prevX=e.clientX; prevY=e.clientY; }});
document.addEventListener("mouseup", e=>{ if(e.button===2) isRightDown=false; });
document.addEventListener("mousemove", e=>{
  if(isRightDown){
    const dx=e.clientX-prevX, dy=e.clientY-prevY;
    yaw -= dx*0.002; pitch -= dy*0.002;
    pitch=Math.max(-Math.PI/2,Math.min(Math.PI/2,pitch));
    prevX=e.clientX; prevY=e.clientY;
  }
});
document.addEventListener("contextmenu", e=>e.preventDefault());

// --- Settings System ---
const settingsPanel = document.getElementById("settingsPanel");
const playableToggle = document.getElementById("playableToggle");
const testButton = document.getElementById("testButton");
let isPlayable = false;
let inTest = false;

document.getElementById("openSettings").onclick = ()=> settingsPanel.style.display = "block";
function closeSettings(){ settingsPanel.style.display = "none"; }

playableToggle.onchange = ()=>{
  isPlayable = playableToggle.checked;
  testButton.style.display = isPlayable ? "block" : "none";
};

// --- Test Mode ---
testButton.onclick = ()=>{
  if(!inTest){
    document.getElementById("sidebar").style.display="none";
    document.getElementById("editor").style.display="none";
    testButton.textContent="Stop Test";
    inTest=true;
  } else {
    document.getElementById("sidebar").style.display="block";
    document.getElementById("editor").style.display="flex";
    testButton.textContent="Test";
    inTest=false;
  }
};

// --- Animation ---
function animate(){
  requestAnimationFrame(animate);

  const forward = new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
  const right = new THREE.Vector3(Math.sin(yaw+Math.PI/2),0,Math.cos(yaw+Math.PI/2));
  const velocity = new THREE.Vector3();
  if(move.w) velocity.add(forward);
  if(move.s) velocity.sub(forward);
  if(move.a) velocity.sub(right);
  if(move.d) velocity.add(right);
  velocity.normalize().multiplyScalar(0.1);

  if(inTest){
    let nextPos = camera.position.clone().add(velocity);
    let collided = false;

    for(const b of Object.values(blocks)){
      if(!b.collision) continue;
      const dist = nextPos.distanceTo(b.mesh.position);
      const size = Math.max(...b.size);
      if(dist < size){ collided = true; break; }
    }

    const halfGrid = gridSize/2;
    if(Math.abs(nextPos.x) > halfGrid || Math.abs(nextPos.z) > halfGrid){
      fallSpeed -= 0.01;
      camera.position.y += fallSpeed;
    } else {
      fallSpeed = 0;
    }

    if(!collided) camera.position.copy(nextPos);
  } else {
    camera.position.add(velocity);
  }

  const lookDir = new THREE.Vector3(Math.sin(yaw), Math.sin(pitch), Math.cos(yaw));
  camera.lookAt(camera.position.clone().add(lookDir));
  renderer.render(scene,camera);
}
animate();

// --- Filhantering ---
document.getElementById("newFile").onclick = ()=>{
  const name = prompt("Filnamn (t.ex. script.V++):");
  if(!name) return;
  files[name] = "// Ny Vidga-fil\n";
  addFileButton(name);
};
document.getElementById("addBlock").onclick = addBlock;
document.getElementById("runCode").onclick = ()=>{
  if(!currentFile) return alert("Ingen fil vald!");
  files[currentFile] = codeArea.value;
  parseVidgaCode(currentFile, codeArea.value);
};

// --- Parser ---
function parseVidgaCode(name, code){
  if(name.endsWith(".VBC")){
    const b = blocks[name];
    if(!b) return;
    if(code.trim()===""){ scene.remove(b.mesh); delete blocks[name]; return; }

    const col=code.match(/Collision\((true|false)\)/i);
    if(col){ b.collision = col[1]==="true"; b.mesh.material.color.set(b.collision?0xff0000:0x00ff88); }

    const size=code.match(/size\s*=\s*(\d+),(\d+),(\d+)/i);
    if(size){ const [x,y,z]=[parseFloat(size[1])/10,parseFloat(size[2])/10,parseFloat(size[3])/10]; b.mesh.scale.set(x,y,z); b.size=[x,y,z]; }

    const coord=code.match(/Coordinate\(([-\d.]+),([-\d.]+),([-\d.]+)\)/i);
    if(coord){ const [x,y,z]=[parseFloat(coord[1]),parseFloat(coord[2]),parseFloat(coord[3])]; b.mesh.position.set(x,y,z); }
  }
  else if(name.endsWith(".V++")){
    const flipMatch = code.match(/flipGrid\((true|false)\)/i);
    if(flipMatch) flipGrid(flipMatch[1] === "true");

    const expandMatch = code.match(/GridExpandSize\((\d+),(\d+),(\d+)\)/i);
    if(expandMatch) GridExpandSize(
      parseInt(expandMatch[1]),
      parseInt(expandMatch[2]),
      parseInt(expandMatch[3])
    );
  }
}

// --- Gridfunktioner ---
function flipGrid(state){
  grid.rotation.x = state ? Math.PI : 0;
  grid.position.y = state ? 10 : 0;
}

function GridExpandSize(x, y, z){
  scene.remove(grid);
  gridSize = Math.max(x, y, z);
  grid = new THREE.GridHelper(gridSize, gridSize, 0x00ff00, 0x004400);
  grid.scale.set(x / 50, y / 50, z / 50);
  scene.add(grid);
}
</script>
</body>
</html>
